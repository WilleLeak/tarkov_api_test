import requests
import json
from datetime import datetime
import os

dir_path = r'C:\Users\farns\python_practice\python_stuff\tarkov_api_test'

def craft_query():
    return """
        {
        crafts{
            rewardItems{
                item{
                    name
                }
                count
            }
            requiredItems{
                item{
                    name
                    buyFor{
                        priceRUB
                    }
                }
                count
                attributes{
                    name
                    value
                }
            } 
        } 
        }
        """ 
    
def find_craft(crafted_item):
    cost_dict = {'Crafted item': crafted_item, 'Required items': {}} 
    reward_count = 0

    response = requests.post('https://api.tarkov.dev/graphql', json={'query': craft_query()})
    if response.status_code != 200:
        raise Exception('Query failed to run by returning code of {}. {}'.format(response.status_code, craft_query()))
    else:
        crafts = response.json()['data']['crafts']
        
    for craft in crafts:
        for reward_item in craft['rewardItems']:
            if reward_item['item']['name'] == crafted_item:
                reward_count = reward_item['count']
                for required_items in craft['requiredItems']:
                    name = required_items['item']['name']
                    if len(required_items['attributes']) > 0:
                        cost = 0
                    else:
                        cheapest_cost = 1_000_000_000
                        for vendor in required_items['item']['buyFor']:
                            if vendor['priceRUB'] < cheapest_cost:
                                cheapest_cost = vendor['priceRUB']
                                cheapest_cost *= required_items['count']
                        cost = cheapest_cost
                    cost_dict['Required items'][name] = cost


    total_cost = 0
    # for cost in cost_dict.values():
    #     if isinstance(cost, int):
    #         total_cost += cost
            
    for name, cost in cost_dict['Required items'].items():
        total_cost += cost
            
    current_date = datetime.now().strftime('%Y-%m-%d')
    
    cost_dict['Price (RUB)'] = total_cost
    cost_dict['Items crafted'] = reward_count
    cost_dict['Price per item'] = round((total_cost / reward_count), 2)
    cost_dict['Date'] = current_date
    #print(f'The current cost of the {crafted_item} craft is: {total_cost} RUB')
    
    return cost_dict

# TODO: write this method, it saves the craft as a .json or creates a new .json in 
#       location dir_path
def save_craft_json(crafted_item):
    file_name = crafted_item + '_craft_data.json'
    file_path = dir_path + '\\' + file_name
    cost_dict = find_craft(crafted_item)
    
    
    if os.path.isfile(file_path):
        print('file found')
        with open(file_path, 'a') as file:
            json.dump(cost_dict, file, indent=4)
            file.write('\n')
    else:
        print('file not found: created new file')
        with open(file_path, 'w') as file:
            json.dump(cost_dict, file, indent=4)
            file.write('\n')
    
    
    
            
            
# common crafted items:
    # 7.62x39mm BP gzh
    # 9x21mm BT gzh
    # 5.56x45mm M995
    # 9x19mm RIP
    # Ox bleach
    # Soap
    # Fleece fabric
    # Propital regenerative stimulant injector
    # Pile of meds
    # AI-2 medkit

    

    
#print(find_craft('9x21mm BT gzh'))
save_craft_json('7.62x39mm BP gzh')


    # for craft in crafts:
    #     for reward_item in craft['rewardItems']:
    #         if reward_item['item']['name'] == crafted_item:
    #             reward_count = reward_item['count']
    #             for required_items in craft['requiredItems']:
    #                 name = required_items['item']['name']
    #                 if len(required_items['attributes']) > 0:
    #                     cost = 0
    #                 else:
    #                     cheapest_cost = 1_000_000_000
    #                     for vendor in required_items['item']['buyFor']:
    #                         if vendor['priceRUB'] < cheapest_cost:
    #                             cheapest_cost = vendor['priceRUB']
    #                             cheapest_cost *= required_items['count']
    #                     cost = cheapest_cost
    #                 cost_dict[name] = cost
